
let match = {
    "_id": "58b42a1e7115eaa110692477",
    "date": "2017/01/02 12:00",
    "team1": {
        "name": "Червени",
        "result": "13",
        "player1": {
            "_id": "58b429ae86f834ad30cd387c",
            "username": "Борил Хаджийски",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player2": {
            "_id": "58b429b37115eaa1106922fe",
            "username": "Калин Видински",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player3": {
            "_id": "58b429b77115eaa11069230a",
            "username": "Михаил Янков",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player4": {
            "_id": "58b429bab51bafaa20546811",
            "username": "Иван Дончев",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player5": {
            "_id": "58b429be655de25b54894ceb",
            "username": "Калоян Станчев",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player6": {
            "_id": "58b429c2c273ec2453b3f8dc",
            "username": "Йоан Петрушинов",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "rank": "6000",
        "points": "0"
    },
    "team2": {
        "name": "Сини",
        "result": "11",
        "player1": {
            "_id": "58b429c58f406ed774d168ed",
            "username": "Даниел Илиев",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player2": {
            "_id": "58b429c90db48b4d640c2efa",
            "username": "Иван Иванов",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player3": {
            "_id": "58b429ccc273ec2453b3f8f5",
            "username": "Боян Кърпачев",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player4": {
            "_id": "58b429d2470df63a31a4738d",
            "username": "Веселин Десподов",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player5": {
            "_id": "58b429d668e0999d21d3a76f",
            "username": "Цеци Шишков",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player6": {
            "_id": "58b429dab51bafaa2054686d",
            "username": "Милко Филипов",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "rank": "6000",
        "points": "0"
    },
    "_acl": {
        "creator": "58b429734d9b077942db0a42"
    },
    "_kmd": {
        "lmt": "2017-02-27T13:31:12.128Z",
        "ect": "2017-02-27T13:31:10.155Z"
    }
};
let match2 = {
    "_id": "58b42a1e7115eaa110692477",
    "date": "2017/01/02 12:00",
    "team1": {
        "name": "Червени",
        "result": "13",
        "player1": {
            "_id": "58b429ae86f834ad30cd387c",
            "username": "Борил Хаджийски",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player2": {
            "_id": "58b429b37115eaa1106922fe",
            "username": "Калин Видински",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player3": {
            "_id": "58b429b77115eaa11069230a",
            "username": "Михаил Янков",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player4": {
            "_id": "58b429bab51bafaa20546811",
            "username": "Иван Дончев",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player5": {
            "_id": "58b429be655de25b54894ceb",
            "username": "Калоян Станчев",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player6": {
            "_id": "58b429c2c273ec2453b3f8dc",
            "username": "Йоан Петрушинов",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "rank": "6000",
        "points": "0"
    },
    "team2": {
        "name": "Сини",
        "result": "11",
        "player1": {
            "_id": "58b429c58f406ed774d168ed",
            "username": "Даниел Илиев",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player2": {
            "_id": "58b429c90db48b4d640c2efa",
            "username": "Иван Иванов",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player3": {
            "_id": "58b429ccc273ec2453b3f8f5",
            "username": "Боян Кърпачев",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player4": {
            "_id": "58b429d2470df63a31a4738d",
            "username": "Веселин Десподов",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player5": {
            "_id": "58b429d668e0999d21d3a76f",
            "username": "Цеци Шишков",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "player6": {
            "_id": "58b429dab51bafaa2054686d",
            "username": "Милко Филипов",
            "playerstats": {
                "points": "0",
                "rank": "1000",
                "matches": "0",
                "wins": "0",
                "draws": "0",
                "losses": "0"
            }
        },
        "rank": "6000",
        "points": "0"
    },
    "_acl": {
        "creator": "58b429734d9b077942db0a42"
    },
    "_kmd": {
        "lmt": "2017-02-27T13:31:12.128Z",
        "ect": "2017-02-27T13:31:10.155Z"
    }
};

match2.team1.player1.playerstats.points = 17;
match2.team1.name = "test";

console.log(match2.team1.name)

let playersForUpdateTeam1 = [];
let playersForUpdateTeam2 = [];

playersForUpdateTeam1.push(match2.team1.player1);
playersForUpdateTeam1.push(match2.team1.player2);
playersForUpdateTeam1.push(match2.team1.player3);
playersForUpdateTeam1.push(match2.team1.player4);
playersForUpdateTeam1.push(match2.team1.player5);
playersForUpdateTeam1.push(match2.team1.player6);

playersForUpdateTeam2.push(match2.team2.player1);
playersForUpdateTeam2.push(match2.team2.player2);
playersForUpdateTeam2.push(match2.team2.player3);
playersForUpdateTeam2.push(match2.team2.player4);
playersForUpdateTeam2.push(match2.team2.player5);
playersForUpdateTeam2.push(match2.team2.player6);

function updatePlayer(){
        match2.team2.player1.playerstats.rank = Number(match2.team2.player1.playerstats.rank) + Number(rankTeamOne);
        match2.team2.player1.playerstats.points = Number(match2.team2.player1.playerstats.points) + Number(Math.round(pointsTeamOne));
        match2.team2.player1.playerstats.matches = Number(match2.team2.player1.playerstats.matches) + 1;
        match2.team2.player1.playerstats.wins = Number(match2.team2.player1.playerstats.wins) + Number(winsTeamOne);
        match2.team2.player1.playerstats.draws = Number(match2.team2.player1.playerstats.draws) + Number(drawsTeamOne);
        match2.team2.player1.playerstats.losses = Number(match2.team2.player1.playerstats.losses) + Number(lossesTeamOne);
}



let team1rank = Number(match.team1.player1.playerstats.rank)+
    Number(match.team1.player2.playerstats.rank)+
    Number(match.team1.player3.playerstats.rank)+
    Number(match.team1.player4.playerstats.rank)+
    Number(match.team1.player5.playerstats.rank)+
    Number(match.team1.player6.playerstats.rank);

let team2rank = Number(match.team2.player1.playerstats.rank)+
    Number(match.team2.player2.playerstats.rank)+
    Number(match.team2.player3.playerstats.rank)+
    Number(match.team2.player4.playerstats.rank)+
    Number(match.team2.player5.playerstats.rank)+
    Number(match.team2.player6.playerstats.rank);




let handicap = Math.round((Math.abs(team1rank - team2rank)/50));

let goalDifference = Math.abs(match.team1.result - match.team2.result);
if (goalDifference > 5){
    goalDifference = 5;
}
let coefficient = Math.abs(team1rank - team2rank);
if(coefficient > 200){
    coefficient = 200;
}
let rankTeamOne = 0;
let rankTeamTwo = 0;
let pointsTeamOne = 0;
let pointsTeamTwo = 0;
let winsTeamOne = 0;
let winsTeamTwo = 0;
let drawsTeamOne = 0;
let drawsTeamTwo = 0;
let lossesTeamOne = 0;
let lossesTeamTwo = 0;


if(team1rank > team2rank) {

    //checks only the handicapped result;
    if(match.team1.result > (match.team2.result + handicap)){

        rankTeamOne = 10 + goalDifference - handicap;
        rankTeamTwo = - 10 - goalDifference + handicap;
    }
    else if((match.team1.result + handicap) < match.team2.result){

        rankTeamOne = - 10 - goalDifference - handicap;
        rankTeamTwo = 10 + goalDifference + handicap;
    }

    //checks the actual result;
    if(match.team1.result > (match.team2.result )){

        winsTeamOne = 1;
        lossesTeamTwo = 1;
        pointsTeamOne = (10+goalDifference)*100/(100+coefficient);
        pointsTeamTwo = (5-goalDifference)*(100+coefficient)/100;
        updatePlayer();
    }
    else if(match.team1.result < (match.team2.result)){

        winsTeamTwo = 1;
        lossesTeamOne = 1;
        pointsTeamOne = (5-goalDifference)*100/(100+coefficient);
        pointsTeamTwo = (10+goalDifference)*(100+coefficient)/100;
        updatePlayer();
    }

    else if(match.team1.result == (match.team2.result)){

        drawsTeamOne = 1;
        drawsTeamTwo = 1;
        pointsTeamOne = 5*100/(100+coefficient);
        pointsTeamTwo = 5*(100+coefficient)/100;
        updatePlayer();
    }
}
else if(team1rank < team2rank) {

    //checks the handicapped result only;
    if((match.team1.result + handicap) > match.team2.result){

        rankTeamOne = 10 + goalDifference + handicap;
        rankTeamTwo = - 10 - goalDifference - handicap;
    }
    else if((match.team1.result + handicap) < match.team2.result){

        rankTeamOne = - 10 - goalDifference + handicap;
        rankTeamTwo = 10 + goalDifference - handicap;
    }

    //checks the actual result;
    if(match.team1.result > (match.team2.result )){

        winsTeamOne = 1;
        lossesTeamTwo = 1;
        pointsTeamOne = (10+goalDifference)*(100+coefficient)/100;
        pointsTeamTwo = (5-goalDifference)*100/(100+coefficient);
        updatePlayer();
    }
    else if(match.team1.result < (match.team2.result)){

        winsTeamTwo = 1;
        lossesTeamOne = 1;
        pointsTeamOne = (5-goalDifference)*(100+coefficient)/100;
        pointsTeamTwo = (10+goalDifference)*100/(100+coefficient);
        updatePlayer();
    }

    else if(match.team1.result == (match.team2.result)){

        drawsTeamOne = 1;
        drawsTeamTwo = 1;
        pointsTeamOne = 5*(100+coefficient)/100;
        pointsTeamTwo = 5*100/(100+coefficient);
        updatePlayer();
    }
}
else if(team1rank == team2rank) {
    if(match.team1.result > match.team2.result){

        rankTeamOne = 10 + goalDifference;
        rankTeamTwo = - 10 - goalDifference;
    }
    else if(match.team1.result < match.team2.result){

        rankTeamOne = - 10 - goalDifference;
        rankTeamTwo = 10 + goalDifference;
    }

    //checks the actual result;
    if(match.team1.result > (match.team2.result )){

        winsTeamOne = 1;
        lossesTeamTwo = 1;
        pointsTeamOne = 10 + goalDifference;
        pointsTeamTwo = 5 - goalDifference;
        updatePlayer();
    }
    else if(match.team1.result < (match.team2.result)){

        winsTeamTwo = 1;
        lossesTeamOne = 1;
        pointsTeamOne = 5 - goalDifference;
        pointsTeamTwo = 10 + goalDifference;
        updatePlayer();
    }

    else if(match.team1.result == (match.team2.result)){

        drawsTeamOne = 1;
        drawsTeamTwo = 1;
        pointsTeamOne = 5;
        pointsTeamTwo = 5;
        updatePlayer();
    }
    let debug = "";

}

console.log(rankTeamOne);
console.log(pointsTeamOne);
console.log(match2.team2.player1.playerstats.rank);
console.log(match2.team2.player1.playerstats.points);
console.log(match2.team2.player1.playerstats.matches);
console.log(match2.team2.player1.playerstats.wins);

match.team1.rank = Number(team1rank);
match.team2.rank = Number(team2rank);
match.team1.points = Number(pointsTeamOne);
match.team2.points = Number(pointsTeamTwo);
